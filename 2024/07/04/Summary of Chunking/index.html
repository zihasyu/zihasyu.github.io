<!-- build time:Thu Jul 25 2024 16:43:36 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="referrer" content="no-referrer"><link rel="alternate" type="application/rss+xml" title="carzo" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="carzo" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="carzo" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Chunking,Compression,Storage system,Operating system,Computer science"><link rel="canonical" href="http://example.com/2024/07/04/Summary%20of%20Chunking/"><title>Chunking summary - Compression algorithms | carzo = carzo = Zihasyu's Personal Site</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Chunking summary</h1><div class="meta"><span class="item" title="Created: 2024-07-04 19:48:04"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2024-07-04T19:48:04+08:00">2024-07-04</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>3.4k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>3 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">carzo</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav><meta name="referrer" content="no-referrer"></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://raw.githubusercontent.com/zihasyu/zihasyu.github.io/master/images/avatar.jpg"></li><li class="item" data-background-image="https://raw.githubusercontent.com/zihasyu/zihasyu.github.io/master/images/avatar.jpg"></li><li class="item" data-background-image="https://raw.githubusercontent.com/zihasyu/zihasyu.github.io/master/images/avatar.jpg"></li><li class="item" data-background-image="https://raw.githubusercontent.com/zihasyu/zihasyu.github.io/master/images/avatar.jpg"></li><li class="item" data-background-image="https://raw.githubusercontent.com/zihasyu/zihasyu.github.io/master/images/avatar.jpg"></li><li class="item" data-background-image="https://raw.githubusercontent.com/zihasyu/zihasyu.github.io/master/images/avatar.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Compression-algorithms/" itemprop="item" rel="index" title="In Compression algorithms"><span itemprop="name">Compression algorithms</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="http://example.com/2024/07/04/Summary%20of%20Chunking/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Zihasyu"><meta itemprop="description" content="Zihasyu's Personal Site, Hope friends and I can get the happiness we deserve"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="carzo"></span><div class="body md" itemprop="articleBody"><h2 id="chunking-flow"><a class="anchor" href="#chunking-flow">#</a> Chunking flow</h2><h3 id="flow-chart"><a class="anchor" href="#flow-chart">#</a> Flow chart</h3><p><img data-src="https://notepic-1327795028.cos.ap-chengdu.myqcloud.com/pic/202407251358457.png" alt="image.png"></p><h3 id="why-only-read-part"><a class="anchor" href="#why-only-read-part">#</a> Why only Read part\</h3><p>we unuslly read 128MiB a time from the Tar to Chunking. this will prevent too much memory from being consumed.<br>when the ReadFileBuffer is about to reach the end, we need to seekg the next beginning of the buffer.</p><h3 id="code-sample"><a class="anchor" href="#code-sample">#</a> Code sample</h3><pre><code class="language-c++">void Chunker::Chunking()
&#123;
    bool end = false;
    uint32_t totalOffset = 0;
    while (!end)
    &#123;
        memset((char *)readFileBuffer, 0, sizeof(uint8_t) * READ_FILE_SIZE);
        inputFile.read((char *)readFileBuffer, sizeof(uint8_t) * READ_FILE_SIZE);
        end = inputFile.eof();
        size_t len = inputFile.gcount();
        if (len == 0)
        &#123;
            break;
        &#125;
        localOffset = 0;
        while (((len - localOffset) &gt;= MAXCHUNKSIZE) || (end &amp;&amp; (localOffset &lt; len)))
        &#123;
            Chunk_t chunk;
            uint32_t cp = 0;
            cp = CutPoint(readFileBuffer + localOffset, len - localOffset);
            chunk.chunkPtr = (uint8_t *)malloc(cp);
            memcpy(chunk.chunkPtr, readFileBuffer + localOffset, cp);
            chunk.chunkSize = cp;
            localOffset += cp;
        &#125;
        totalOffset += localOffset;
        inputFile.seekg(totalOffset, ios_base::beg);
    &#125;
    return;
&#125;
</code></pre><h2 id="chunking-methods"><a class="anchor" href="#chunking-methods">#</a> Chunking methods</h2><p>the different chunking methods are reflected in the way cp is obtained.</p><pre><code class="language-C++">uint32_t cp = Chunking(); 
</code></pre><h3 id="fixed-size"><a class="anchor" href="#fixed-size">#</a> Fixed-size</h3><p>As a tradeoff between Deduplication and throughput, chunking methods typically use 8KiB as the desired average size.</p><pre><code class="language-C++">uint32_t Chunker::FixedSize()&#123;
		return FixedChunkSize;
&#125;
</code></pre><p>But the fixed-size chunking will encounter a very serious boundary migration problem, which will allow the reactivity to drop.</p><h3 id="cdc"><a class="anchor" href="#cdc">#</a> CDC</h3><p>When the sliding hash in the window is equal to 0 with the mask that operation set in advance, it is used as a breakpoint.This is called content-defined chunking.</p><pre><code class="language-c++">uint32_t Chunker::CutPointCDC(const uint8_t *src, const uint32_t len)
&#123;
    uint32_t fp = 0;
    uint32_t i = 0;
    for (; i &lt; len; i++)
    &#123;
        fp = fp - Rabin[src[i-windowSize]] + Rabin[src[i]];
        if (!(fp &amp; MASK_GEAR))
        &#123;
            return (i + 1);
        &#125;
    &#125;
    return i;
&#125;;
</code></pre><p>The expected block size is related to the significant bit 1 of the mask. For example, if I want the block size to be 8KiB on average, then I need 13 1's in the mask.</p><h3 id="gear"><a class="anchor" href="#gear">#</a> Gear</h3><p>Gear Hash reduces the computational overhead of the rolling hash by fixing the significant bit 1 of the mask to be the least significant bit, so that gear can obtain the rolling hash value by bit operation.</p><pre><code class="language-c++">uint32_t Chunker::CutPointGear(const uint8_t *src, const uint32_t len)
&#123;
    uint32_t fp = 0;
    uint32_t i = 0;
    for (; i &lt; len; i++)
    &#123;
        fp = (fp &gt;&gt; 1) + GEAR[src[i]];
        if (!(fp &amp; MASK_GEAR))
        &#123;
            return (i + 1);
        &#125;
    &#125;
    return i;
&#125;;
</code></pre><h3 id="fastcdc"><a class="anchor" href="#fastcdc">#</a> FastCDC</h3><p>FastCDC solves two problems, one is to further improve throughput, and the other is to standardize block sizes in the 4KiB-16KiB range. It skips the first 4KiB without having to compute the hash, and its mask is also standardized to be bitwise, so that when it reaches 16KiB, it immediately gets the breakpoint, whether it meets the breakpoint condition or not. In addition, to achieve an average size of 8KiB, he uses different masks to generate breakpoints in 4K-8K and 8K-16K.</p><pre><code class="language-c++">uint32_t Chunker::CutPointFastCDC(const uint8_t *src, const uint32_t len)
&#123;
    uint32_t n;
    uint32_t fp = 0;
    uint32_t i;
    i = min(len, static_cast&lt;uint32_t&gt;(minChunkSize));
    n = min(normalSize, len);
    for (; i &lt; n; i++)
    &#123;
        fp = (fp &gt;&gt; 1) + GEAR[src[i]];
        if (!(fp &amp; maskS))
        &#123;
            return (i + 1);
        &#125;
    &#125;

    n = min(static_cast&lt;uint32_t&gt;(maxChunkSize), len);
    for (; i &lt; n; i++)
    &#123;
        fp = (fp &gt;&gt; 1) + GEAR[src[i]];
        if (!(fp &amp; maskL))
        &#123;
            return (i + 1);
        &#125;
    &#125;
    return i;
&#125;;
</code></pre><h3 id="mtar"><a class="anchor" href="#mtar">#</a> mTar</h3><p>mTar argues that the metadata head of the periodic appearance of tar reduces the Deduplication rate</p><pre><code class="language-c++">void MTar()&#123;
	translate the Tar files to mTar files;
&#125;;

FastCDC();

</code></pre><h2 id="conclusion"><a class="anchor" href="#conclusion">#</a> Conclusion</h2><p>The chunking method is a part of the compression system that determines the theoretical upper bound. If the obtained chunk contains extremely high boundary offset, then the best feature value selection method cannot obtain excellent results.</p><div class="tags"><a href="/tags/Chunking/" rel="tag"><i class="ic i-tag"></i> Chunking</a> <a href="/tags/Compression/" rel="tag"><i class="ic i-tag"></i> Compression</a> <a href="/tags/Storage-system/" rel="tag"><i class="ic i-tag"></i> Storage system</a> <a href="/tags/Operating-system/" rel="tag"><i class="ic i-tag"></i> Operating system</a> <a href="/tags/Computer-science/" rel="tag"><i class="ic i-tag"></i> Computer science</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2024-07-25 16:33:58" itemprop="dateModified" datetime="2024-07-25T16:33:58+08:00">2024-07-25</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Zihasyu WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Zihasyu Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Zihasyu PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Zihasyu <i class="ic i-at"><em>@</em></i>carzo</li><li class="link"><strong>Post link: </strong><a href="http://example.com/2024/07/04/Summary%20of%20Chunking/" title="Chunking summary">http://example.com/2024/07/04/Summary of Chunking/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"></div><div class="item right"><a href="/2024/07/22/hello-world/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;i0.hdslb.com&#x2F;bfs&#x2F;new_dyn&#x2F;e2012a4c377eb1e2c0d1db3f36799444693747944.png@690w.avif" title="Hello World"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>Hello World</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#chunking-flow"><span class="toc-number">1.</span> <span class="toc-text">Chunking flow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#flow-chart"><span class="toc-number">1.1.</span> <span class="toc-text">Flow chart</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#why-only-read-part"><span class="toc-number">1.2.</span> <span class="toc-text">Why only Read part\</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#code-sample"><span class="toc-number">1.3.</span> <span class="toc-text">Code sample</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chunking-methods"><span class="toc-number">2.</span> <span class="toc-text">Chunking methods</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fixed-size"><span class="toc-number">2.1.</span> <span class="toc-text">Fixed-size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cdc"><span class="toc-number">2.2.</span> <span class="toc-text">CDC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gear"><span class="toc-number">2.3.</span> <span class="toc-text">Gear</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastcdc"><span class="toc-number">2.4.</span> <span class="toc-text">FastCDC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mtar"><span class="toc-number">2.5.</span> <span class="toc-text">mTar</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#conclusion"><span class="toc-number">3.</span> <span class="toc-text">Conclusion</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li class="active"><a href="/2024/07/04/Summary%20of%20Chunking/" rel="bookmark" title="Chunking summary">Chunking summary</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Zihasyu" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Zihasyu</p><div class="description" itemprop="description">Hope friends and I can get the happiness we deserve</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">2</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">1</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">5</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ppaGFzeXU=" title="https:&#x2F;&#x2F;github.com&#x2F;zihasyu"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2024/07/22/hello-world/" title="Hello World">Hello World</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Compression-algorithms/" title="In Compression algorithms">Compression algorithms</a></div><span><a href="/2024/07/04/Summary%20of%20Chunking/" title="Chunking summary">Chunking summary</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Zihasyu @ carzo</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">4k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">3 mins.</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2024/07/04/Summary of Chunking/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->